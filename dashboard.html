<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rejected Bookings Intelligence</title>

    <!-- Google Fonts - Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        :root {
            /* Dark Mode (default) */
            --bg-primary: #080c14;
            --bg-secondary: rgba(15, 23, 42, 0.9);
            --bg-tertiary: rgba(30, 41, 59, 0.7);
            --text-primary: #ffffff;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: rgba(148, 163, 184, 0.1);
            --card-shadow: rgba(0, 0, 0, 0.3);
            --glass-bg: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.7) 100%);
            --table-header-bg: rgba(15, 23, 42, 0.6);
            --table-row-hover: rgba(122, 95, 181, 0.08);
        }

        .light-mode {
            --bg-primary: #f8fafc;
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --bg-tertiary: rgba(241, 245, 249, 0.9);
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border-color: rgba(148, 163, 184, 0.3);
            --card-shadow: rgba(0, 0, 0, 0.08);
            --glass-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(241, 245, 249, 0.9) 100%);
            --table-header-bg: rgba(241, 245, 249, 0.95);
            --table-row-hover: rgba(122, 95, 181, 0.1);
        }

        .light-mode {
            background-image:
                radial-gradient(at 0% 0%, hsla(220, 50%, 95%, 1) 0, transparent 50%),
                radial-gradient(at 60% 0%, hsla(210, 60%, 92%, 1) 0, transparent 45%),
                radial-gradient(at 100% 0%, hsla(250, 40%, 94%, 1) 0, transparent 50%);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            margin: 0;
            background-image:
                radial-gradient(at 0% 0%, hsla(220, 50%, 12%, 1) 0, transparent 50%),
                radial-gradient(at 60% 0%, hsla(210, 60%, 15%, 1) 0, transparent 45%),
                radial-gradient(at 100% 0%, hsla(250, 40%, 14%, 1) 0, transparent 50%);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Headers use Poppins */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        .header-font {
            font-family: 'Poppins', sans-serif;
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #60a5fa;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .spinning-logo {
            animation: spin 2s linear infinite;
        }

        .fixed-branding {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .fixed-branding:hover {
            opacity: 1;
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 30px var(--card-shadow);
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .light-mode .glass-card {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06), 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        /* Theme Toggle Switch */
        .theme-toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .light-mode .theme-toggle {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            border-color: rgba(14, 165, 233, 0.3);
        }

        .theme-toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #7A5FB5 0%, #a78bfa 100%);
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(122, 95, 181, 0.4);
        }

        .light-mode .theme-toggle-slider {
            left: 33px;
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
        }

        /* Light mode specific text adjustments */
        .light-mode .text-white {
            color: var(--text-primary) !important;
        }

        .light-mode .text-slate-400,
        .light-mode .text-slate-300,
        .light-mode .text-slate-500 {
            color: var(--text-muted) !important;
        }

        .light-mode .text-slate-100 {
            color: var(--text-secondary) !important;
        }

        .light-mode select {
            background-color: rgba(255, 255, 255, 0.95);
            color: #1e293b;
            border-color: rgba(148, 163, 184, 0.4);
        }

        .light-mode select:hover {
            background-color: rgba(241, 245, 249, 0.95);
        }

        .light-mode .table-row:hover {
            background: linear-gradient(90deg, rgba(122, 95, 181, 0.12) 0%, transparent 100%) !important;
        }

        .light-mode thead {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%) !important;
        }

        .light-mode thead th {
            color: #475569 !important;
        }

        .light-mode .text-cyan-300 {
            color: #0891b2 !important;
        }

        .light-mode .text-sky-200 {
            color: #0284c7 !important;
        }

        .light-mode .text-amber-300 {
            color: #d97706 !important;
        }

        .light-mode .text-rose-400 {
            color: #e11d48 !important;
        }

        /* Light mode - Table section header (Booking Details) */
        .light-mode .bg-gradient-to-r {
            background: linear-gradient(90deg, #f1f5f9 0%, #e2e8f0 100%) !important;
        }

        .light-mode .border-slate-700\/50,
        .light-mode .border-slate-700 {
            border-color: rgba(148, 163, 184, 0.3) !important;
        }

        .light-mode .divide-slate-800\/40>*+* {
            border-color: rgba(148, 163, 184, 0.2) !important;
        }

        /* Light mode - Table body backgrounds */
        .light-mode tbody {
            background-color: #ffffff;
        }

        .light-mode tbody tr {
            background-color: #ffffff !important;
        }

        .light-mode tbody tr:nth-child(even) {
            background-color: #f8fafc !important;
        }

        /* Light mode - Button styling */
        .light-mode button.bg-slate-800\/90,
        .light-mode .bg-slate-800\/90 {
            background-color: #e2e8f0 !important;
            color: #475569 !important;
            border-color: rgba(148, 163, 184, 0.4) !important;
        }

        .light-mode button.bg-slate-800\/90:hover,
        .light-mode .bg-slate-800\/90:hover {
            background-color: #cbd5e1 !important;
            color: #1e293b !important;
        }

        /* Light mode - Badge and pill styling */
        .light-mode .bg-slate-800 {
            background-color: #e2e8f0 !important;
            color: #475569 !important;
        }

        /* Light mode - Top 5 reasons cards gradient bars */
        .light-mode .bg-slate-600 {
            background-color: #94a3b8 !important;
        }

        /* Light mode - Ranking text colors */
        .light-mode .text-slate-500 {
            color: #64748b !important;
        }

        /* Light mode - Table cell text */
        .light-mode td {
            color: #334155 !important;
        }

        .light-mode .font-mono {
            color: #475569 !important;
        }

        /* Light mode - Emerald values should stay vibrant */
        .light-mode .text-emerald-400 {
            color: #059669 !important;
        }

        /* Light mode - Brand accent color adjustments */
        .light-mode .text-brand-400 {
            color: #6B4FA6 !important;
        }

        /* Light mode - Purple accents */
        .light-mode .text-purple-400 {
            color: #7c3aed !important;
        }

        /* Light mode - Orange accents */
        .light-mode .text-orange-400 {
            color: #ea580c !important;
        }

        /* Light mode - Filter badges */
        .light-mode .bg-brand-500\/20 {
            background-color: rgba(122, 95, 181, 0.15) !important;
        }

        .light-mode .bg-violet-500\/20 {
            background-color: rgba(139, 92, 246, 0.15) !important;
        }

        /* KPI Card styling */
        .kpi-card p.text-xs,
        .kpi-card p.text-2xl,
        .kpi-card p.text-lg,
        .kpi-card p.text-sm {
            font-family: 'Poppins', sans-serif;
        }

        .kpi-card p.text-2xl,
        .kpi-card p.text-lg {
            letter-spacing: -0.02em;
        }

        .kpi-card p.text-xs.uppercase {
            letter-spacing: 0.1em;
            font-weight: 600;
        }

        /* Text wrapping for broker/agent names */
        .name-wrap {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            line-height: 1.3;
            max-width: 100%;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 30px rgba(96, 165, 250, 0.15);
            }

            50% {
                box-shadow: 0 0 50px rgba(96, 165, 250, 0.3);
            }
        }

        /* Animated gradient for title */
        @keyframes gradient-shift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .animated-gradient-text {
            background: linear-gradient(90deg, #7A5FB5, #60a5fa, #a78bfa, #7A5FB5);
            background-size: 300% 300%;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-shift 4s ease infinite;
        }

        /* Logo color filter - synced with title gradient colors */
        /* Colors: #7A5FB5 (purple) → #60a5fa (blue) → #a78bfa (violet) → back */
        @keyframes logo-color-shift {
            0% {
                /* #7A5FB5 - Purple */
                filter: brightness(0) saturate(100%) invert(38%) sepia(20%) saturate(1500%) hue-rotate(222deg) brightness(95%) contrast(90%);
            }

            33% {
                /* #60a5fa - Blue */
                filter: brightness(0) saturate(100%) invert(60%) sepia(50%) saturate(700%) hue-rotate(190deg) brightness(100%) contrast(95%);
            }

            66% {
                /* #a78bfa - Violet */
                filter: brightness(0) saturate(100%) invert(55%) sepia(30%) saturate(1000%) hue-rotate(230deg) brightness(100%) contrast(90%);
            }

            100% {
                /* Back to #7A5FB5 - Purple */
                filter: brightness(0) saturate(100%) invert(38%) sepia(20%) saturate(1500%) hue-rotate(222deg) brightness(95%) contrast(90%);
            }
        }

        .animated-logo {
            animation: logo-color-shift 4s ease infinite;
        }

        .animate-in {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }

        .delay-1 {
            animation-delay: 0.05s;
        }

        .delay-2 {
            animation-delay: 0.1s;
        }

        .delay-3 {
            animation-delay: 0.15s;
        }

        .delay-4 {
            animation-delay: 0.2s;
        }

        .delay-5 {
            animation-delay: 0.25s;
        }

        .delay-6 {
            animation-delay: 0.3s;
        }

        .kpi-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .kpi-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 0 30px rgba(122, 95, 181, 0.2);
        }

        .table-row {
            transition: all 0.2s ease;
        }

        .table-row:hover {
            background: linear-gradient(90deg, rgba(122, 95, 181, 0.08) 0%, transparent 100%) !important;
        }

        .glow {
            animation: pulse-glow 3s infinite;
        }

        select {
            background-color: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.2);
            color: #e2e8f0;
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
        }

        select:hover {
            border-color: rgba(122, 95, 181, 0.5);
            background-color: rgba(30, 41, 59, 0.9);
        }

        select:focus {
            border-color: #7A5FB5;
            box-shadow: 0 0 0 3px rgba(122, 95, 181, 0.2);
        }

        .gradient-text {
            background: linear-gradient(135deg, #7A5FB5 0%, #60a5fa 50%, #a78bfa 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { dark: { 800: '#1e293b', 900: '#0f172a' }, brand: { 400: '#7A5FB5', 500: '#6B4FA6', 600: '#5C3F97' } }, fontFamily: { sans: ['Segoe UI', 'sans-serif'], heading: ['Poppins', 'sans-serif'] } } }
        }
    </script>

    <!-- React & Babel -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin
        src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
</head>

<body>
    <div id="root" class="h-full">
        <div
            style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8;">
            <div class="loader" style="margin-bottom: 20px;"></div>
            <div style="font-weight: 600;">Initializing...</div>
        </div>
    </div>

    <script type="text/babel">
        try {
            const { useState, useMemo } = React;

            // --- WORKER CODE ---
            const workerCode = `
                importScripts('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');
                self.onmessage = function(e) {
                    try {
                        const data = new Uint8Array(e.data);
                        self.postMessage({ status: 'info', message: 'Reading file...' });
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        self.postMessage({ status: 'info', message: 'Processing data...' });
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                        
                        if (!jsonData.length) throw new Error("No data found");

                        const range = XLSX.utils.decode_range(sheet['!ref']);
                        const dataStartRow = range.s.r + 1; // Data starts after header

                        const keys = Object.keys(jsonData[0]);
                        const match = (targets) => {
                            for(let t of targets) {
                                const found = keys.find(k => k.toLowerCase().replace(/[^a-z]/g,'').includes(t.toLowerCase().replace(/[^a-z]/g,'')));
                                if(found) return found;
                            }
                            return null;
                        };
                        
                        // Helper to get hyperlink or text
                        const getLink = (rowIndex, colIndex) => {
                             const cellAddress = XLSX.utils.encode_cell({c: colIndex, r: rowIndex});
                             const cell = sheet[cellAddress];
                             if (cell && cell.l && cell.l.Target) return cell.l.Target; // Excel Hyperlink
                             if (cell && typeof cell.v === 'string' && (cell.v.startsWith('http') || cell.v.startsWith('www'))) return cell.v; // Raw URL text
                             return '';
                        };

                        // Get headers first to find Column AD (Index 29) safely
                        const headers = XLSX.utils.sheet_to_json(sheet, { header: 1 })[0];
                        const adHeader = headers && headers[29]; // A=0...AD=29

                        const MAP = {
                            val: match(['final sale', 'sale value', 'price', 'amount']),
                            paid: match(['customer paid', 'paid', 'spot cash']),
                            refundStatus: match(['refund', 'refund status']),
                            id: match(['booking id', 'booking_id']),
                            name: match(['booking name', 'name']),
                            unit: match(['unit', 'unit no']),
                            project: match(['project', 'project name']),
                            building: match(['building', 'tower']),
                            cust: match(['customer', 'guest']),
                            stat: match(['status', 'booking status']),
                            date: match(['date', 'booking date', 'date submitted']),
                            rsn: match(['reason', 'reject']),
                            age: match(['aging', 'days']),
                            nat: match(['nationality', 'country']),
                            sales: match(['sales', 'agent', 'sales agent', 'sales person']),
                            agency: match(['agency', 'broker', 'agency name']),
                            month: match(['month']),
                            rejDate: match(['rejected date', 'rejection date', 'date of rejection']),
                            attachment: adHeader || match(['attachment', 'email', 'link', 'hyperlink', 'ref'])
                        };

                        // Extended exclusions: ownership transfer, unit swap, transferred
                        const EXCLUDED_REASONS = ['ownership transfer', 'unit swap', 'unit swapped', 'transferred', 'transfer'];
                        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                        
                        const parseMoney = (v) => {
                            if (typeof v === 'number') return v;
                            if (!v) return 0;
                            const clean = v.toString().replace(/[^0-9.-]/g, '');
                            return parseFloat(clean) || 0;
                        };

                        const parseExcelDate = (v) => {
                            if (!v) return null;
                            
                            // If it's already a Date object (from xlsx library)
                            if (v instanceof Date) {
                                if (isNaN(v.getTime())) return null;
                                
                                // FIX: xlsx sometimes creates dates at 23:59:48 (12 seconds before midnight)
                                // on the PREVIOUS day. If time >= 20:00 (8 PM), round up to next day.
                                const hours = v.getHours();
                                if (hours >= 20) {
                                    const corrected = new Date(v);
                                    corrected.setDate(corrected.getDate() + 1);
                                    corrected.setHours(0, 0, 0, 0);
                                    return corrected;
                                }
                                
                                return v;
                            }
                            
                            let date = null;
                            
                            // Check if string is actually a serial number (e.g., "46042")
                            if (typeof v === 'string') {
                                const strVal = v.toString().trim();
                                // If it's a pure numeric string (5+ digits), treat as serial
                                if (/^\d{5,}$/.test(strVal)) {
                                    const serial = parseInt(strVal);
                                    date = new Date((serial - 25569) * 86400 * 1000);
                                    if (!isNaN(date.getTime())) return date;
                                }
                            }
                            
                            // Serial number (e.g. 45678)
                            if (typeof v === 'number') {
                                date = new Date((Math.round(v) - 25569) * 86400 * 1000);
                                if (!isNaN(date.getTime())) return date;
                            } 
                            
                            // String date - handle DD/MM/YYYY or DD-MM-YYYY or DD MM YYYY
                            if (typeof v === 'string' || v.toString) {
                                const str = v.toString().trim();
                                
                                // Match DD MM YYYY (with /, -, or space separators)
                                const dmy = str.match(/^(\d{1,2})[\s\/\-](\d{1,2})[\s\/\-](\d{2,4})$/);
                                if (dmy) {
                                    let day = parseInt(dmy[1]);
                                    let month = parseInt(dmy[2]);
                                    let year = parseInt(dmy[3]);
                                    
                                    // Handle 2-digit years (26 -> 2026)
                                    if (year < 100) {
                                        year += 2000;
                                    }
                                    
                                    // Validate ranges
                                    if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                                        // Create date at midnight UTC
                                        date = new Date(Date.UTC(year, month - 1, day, 0, 0, 0));
                                        if (!isNaN(date.getTime())) return date;
                                    }
                                }
                                
                                // Try ISO format YYYY-MM-DD
                                const iso = str.match(/^(\d{4})-(\d{2})-(\d{2})/);
                                if (iso) {
                                    const year = parseInt(iso[1]);
                                    const month = parseInt(iso[2]);
                                    const day = parseInt(iso[3]);
                                    date = new Date(Date.UTC(year, month - 1, day, 0, 0, 0));
                                    if (!isNaN(date.getTime())) return date;
                                }
                            }
                            
                            return null;
                        };

                        const rows = jsonData.map((r, i) => {
                            const val = parseMoney(r[MAP.val]);
                            const paid = parseMoney(r[MAP.paid]);
                            
                            const refundRaw = (r[MAP.refundStatus] || '').toString().toLowerCase();
                            const isRefunded = refundRaw.includes('yes') || refundRaw.includes('refunded') || refundRaw.includes('paid');
                            
                            const reason = r[MAP.rsn] || 'Other';
                            const reasonLower = reason.toLowerCase();
                            const isExcludedReason = EXCLUDED_REASONS.some(ex => reasonLower.includes(ex));
                            const earned = (isRefunded || isExcludedReason) ? 0 : paid;
                            
                            const age = parseInt(r[MAP.age]) || 0;
                            
                            // Date Processing (Prioritize Rejected Date)
                            let monthYear = 'Unknown';
                            let formattedRejDate = '-';
                            let dateObj = parseExcelDate(r[MAP.rejDate]);

                            // If rejDate valid, use it
                            if (dateObj) {
                                // xlsx parses dates in LOCAL time, so use LOCAL methods (not UTC)
                                // Using getDate/getMonth instead of getUTCDate/getUTCMonth
                                monthYear = months[dateObj.getMonth()] + '-' + dateObj.getFullYear().toString().slice(-2);
                                formattedRejDate = dateObj.getDate() + '-' + months[dateObj.getMonth()] + '-' + dateObj.getFullYear();
                            } else {
                                // Fallback to existing logic
                                const monthCol = r[MAP.month];
                                if (monthCol && typeof monthCol === 'string') {
                                    const parts = monthCol.split('-');
                                    if (parts.length === 2 && parts[0].length === 3) {
                                        monthYear = monthCol;
                                    }
                                }
                                
                                if (monthYear === 'Unknown' && r[MAP.date]) {
                                    dateObj = parseExcelDate(r[MAP.date]);
                                    if (dateObj) {
                                        monthYear = months[dateObj.getMonth()] + '-' + dateObj.getFullYear().toString().slice(-2);
                                    }
                                }
                            }

                            // Get sales agent and agency - filter out blanks
                            const salesAgent = (r[MAP.sales] || '').toString().trim() || '';
                            const agency = (r[MAP.agency] || '').toString().trim() || '';
                            
                            // Get attachment link (Try Hyperlink Object in Col AD (29) first, then AC (28), then Text Match)
                            // Row index calculation: i is index in jsonData. 
                            const excelRowIdx = dataStartRow + i; 
                            let attachment = getLink(excelRowIdx, 29); // Priority: Col AD Hyperlink
                            if (!attachment) attachment = getLink(excelRowIdx, 28); // Fallback: Col AC Hyperlink
                            if (!attachment) attachment = (r[MAP.attachment] || '').toString().trim(); // Fallback: Mapped Column Text
                            
                            // Validate attachment is a URL
                            if (attachment && !attachment.startsWith('http') && !attachment.startsWith('mailto:')) {
                                attachment = ''; // Discard if it's just text like "Customer requested..."
                            }

                            return {
                                formattedRejDate,
                                name: r[MAP.name] || r[MAP.id] || '-',
                                customer: r[MAP.cust] || '-',
                                unit: r[MAP.unit] || '-',
                                project: r[MAP.project] || '-',
                                building: r[MAP.building] || '-',
                                value: val,
                                paid: paid,
                                earned: earned,
                                isRefunded: isRefunded,
                                refundStatus: r[MAP.refundStatus] || 'No',
                                status: r[MAP.stat] || '-',
                                monthYear: monthYear,
                                reason,
                                aging: age,
                                salesAgent: salesAgent,
                                agency: agency,
                                attachment: attachment
                            };
                        });

                        const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                        const parseMonthYear = (my) => {
                            const parts = my.split('-');
                            const monthIdx = monthNames.indexOf(parts[0]);
                            const year = parseInt('20' + parts[1], 10);
                            return { month: monthIdx, year };
                        };
                        
                        const uniqueMonthYears = [...new Set(rows.map(r => r.monthYear))]
                            .filter(x => x !== 'Unknown')
                            .sort((a, b) => {
                                const pa = parseMonthYear(a);
                                const pb = parseMonthYear(b);
                                // Sort newest first (descending)
                                if (pb.year !== pa.year) return pb.year - pa.year;
                                return pb.month - pa.month;
                            });
                        const uniqueProjects = [...new Set(rows.map(r => r.project))].filter(x => x !== '-').sort();

                        self.postMessage({ status: 'done', data: rows, filters: { monthYears: uniqueMonthYears, projects: uniqueProjects } });

                    } catch(e) { self.postMessage({ status: 'error', message: e.message }); }
                };
            `;

            const Icon = ({ d, size = "w-5 h-5" }) => <svg className={size} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d={d}></path></svg>;

            // File path for auto-load
            const AUTO_LOAD_PATH = 'C:/Users/Norton Araujo/ONE Development/Strategy & Analytics - Documents/03 Users/Norton/Rejected Bookings (Master).xlsx';

            const App = () => {
                const [rawData, setRawData] = useState(null);
                const [filters, setFilters] = useState({ monthYears: [], projects: [] });
                const [selectedMonth, setSelectedMonth] = useState('all');
                const [selectedProject, setSelectedProject] = useState('all');
                const [loading, setLoading] = useState(false);
                const [msg, setMsg] = useState("");
                const [darkMode, setDarkMode] = useState(true);
                const [autoLoadAttempted, setAutoLoadAttempted] = useState(false);

                // Toggle theme
                const toggleTheme = () => {
                    setDarkMode(!darkMode);
                    document.body.classList.toggle('light-mode', darkMode);
                };

                // Auto-load file on mount
                React.useEffect(() => {
                    if (autoLoadAttempted) return;
                    setAutoLoadAttempted(true);

                    const loadData = async () => {
                        setLoading(true);
                        setMsg('Auto-loading file...');

                        try {
                            const protocol = window.location.protocol;
                            let response;
                            let autoLoadSuccess = false;

                            // Try multiple sources in order
                            if (protocol === 'file:') {
                                // Try direct file fetch (requires --allow-file-access-from-files)
                                console.log('Attempting direct file access...');
                                try {
                                    response = await fetch('file:///' + AUTO_LOAD_PATH.replace(/\\/g, '/'));
                                    if (response.ok) autoLoadSuccess = true;
                                } catch (e) {
                                    console.log('Direct file access blocked');
                                }
                            } else {
                                // For HTTP/HTTPS: Try server API first, then fallback to data.xlsx
                                console.log('Attempting server access...');
                                try {
                                    response = await fetch('/api/data');
                                    if (response.ok) {
                                        autoLoadSuccess = true;
                                        console.log('Loaded from server API');
                                    }
                                } catch (e) {
                                    console.log('Server API not available, trying data.xlsx...');
                                }

                                // If server failed, try data.xlsx (for Vercel/static deployment)
                                if (!autoLoadSuccess) {
                                    try {
                                        response = await fetch('./data.xlsx');
                                        if (response.ok) {
                                            autoLoadSuccess = true;
                                            console.log('Loaded from data.xlsx');
                                        }
                                    } catch (e) {
                                        console.log('data.xlsx not found');
                                    }
                                }
                            }

                            if (autoLoadSuccess && response.ok) {
                                const arrayBuffer = await response.arrayBuffer();
                                processArrayBuffer(arrayBuffer);
                            } else {
                                throw new Error('No data source available');
                            }
                        } catch (e) {
                            // Fallback: Show upload screen
                            console.log('Auto-load failed:', e.message);
                            setLoading(false);
                            setMsg('Drag & drop your Excel file to begin');
                        }
                    };

                    loadData();
                }, [autoLoadAttempted]);

                const processArrayBuffer = (arrayBuffer) => {
                    const blob = new Blob([workerCode], { type: 'application/javascript' });
                    const worker = new Worker(URL.createObjectURL(blob));
                    worker.onmessage = (e) => {
                        const { status, message, data, filters } = e.data;
                        if (status === 'info') setMsg(message);
                        else if (status === 'error') { alert("Error: " + message); setLoading(false); }
                        else if (status === 'done') {
                            setRawData(data);
                            setFilters(filters);
                            setLoading(false);
                        }
                    };
                    worker.postMessage(arrayBuffer);
                };

                const processFile = (file) => {
                    setLoading(true);
                    setMsg("Processing...");
                    const reader = new FileReader();
                    reader.onload = (e) => processArrayBuffer(e.target.result);
                    reader.readAsArrayBuffer(file);
                };

                // Theme toggle component
                const ThemeToggle = () => (
                    <div className="theme-toggle" onClick={toggleTheme} title={darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'}>
                        <div className="theme-toggle-slider">
                            {darkMode ? (
                                <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                                </svg>
                            ) : (
                                <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clipRule="evenodd"></path>
                                </svg>
                            )}
                        </div>
                    </div>
                );

                const [currentPage, setCurrentPage] = useState(1);
                const itemsPerPage = 50;

                // Compute filtered data
                const filteredData = useMemo(() => {
                    if (!rawData) return [];
                    let d = rawData;
                    if (selectedMonth !== 'all') d = d.filter(r => r.monthYear === selectedMonth);
                    if (selectedProject !== 'all') d = d.filter(r => r.project === selectedProject);
                    return d;
                }, [rawData, selectedMonth, selectedProject]);

                // Effect to reset page when filters change
                React.useEffect(() => {
                    setCurrentPage(1);
                }, [selectedMonth, selectedProject]);

                // Pagination Logic
                const totalPages = Math.ceil(filteredData.length / itemsPerPage);
                const paginatedData = useMemo(() => {
                    const start = (currentPage - 1) * itemsPerPage;
                    return filteredData.slice(start, start + itemsPerPage);
                }, [filteredData, currentPage]);

                const stats = useMemo(() => {
                    if (!filteredData) return null;

                    let tPaid = 0, tEarned = 0, tRefunded = 0, refundedCount = 0, swappedCount = 0;
                    const reasons = {}, salesAgents = {}, agencies = {};

                    filteredData.forEach(r => {
                        tPaid += r.paid;
                        tEarned += r.earned;
                        if (r.isRefunded) {
                            refundedCount++;
                            tRefunded += r.paid; // Add to total refunded amount
                        }

                        // Count swapped units
                        const reasonLower = r.reason.toLowerCase();
                        if (reasonLower.includes('swap') || reasonLower.includes('swapped')) {
                            swappedCount++;
                        }

                        reasons[r.reason] = (reasons[r.reason] || 0) + 1;

                        if (r.salesAgent && r.salesAgent.length > 0) {
                            salesAgents[r.salesAgent] = (salesAgents[r.salesAgent] || 0) + 1;
                        }
                        if (r.agency && r.agency.length > 0) {
                            agencies[r.agency] = (agencies[r.agency] || 0) + 1;
                        }
                    });

                    const sortedReasons = Object.entries(reasons).map(([name, value]) => ({ name, value })).sort((a, b) => b.value - a.value);
                    const sortedSalesAgents = Object.entries(salesAgents).map(([name, value]) => ({ name, value })).sort((a, b) => b.value - a.value);
                    const sortedAgencies = Object.entries(agencies).map(([name, value]) => ({ name, value })).sort((a, b) => b.value - a.value);

                    return {
                        totalPaid: tPaid,
                        totalEarned: tEarned,
                        totalRefunded: tRefunded,
                        refundedCount,
                        swappedCount,
                        count: filteredData.length,
                        top5Reasons: sortedReasons.slice(0, 5),
                        topSalesAgent: sortedSalesAgents[0] || { name: 'N/A', value: 0 },
                        topAgency: sortedAgencies[0] || { name: 'N/A', value: 0 }
                    };
                }, [filteredData]);

                const formatMoney = (v) => 'AED ' + v.toLocaleString('en-US', { maximumFractionDigits: 0 });

                if (!rawData) {
                    return (
                        <div className="flex h-screen w-full items-center justify-center p-4" style={{ position: 'relative' }}>
                            <div className="glass-card glow max-w-md w-full p-10 text-center rounded-2xl cursor-pointer hover:bg-slate-800/50 transition-all duration-300"
                                onClick={() => !loading && document.getElementById('f').click()}
                                onDragOver={e => e.preventDefault()}
                                onDrop={e => { e.preventDefault(); if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]); }}
                            >
                                <input id="f" type="file" className="hidden" accept=".xlsx,.xls,.csv" onChange={e => e.target.files[0] && processFile(e.target.files[0])} />
                                {loading ? (
                                    <div>
                                        <div className="loader mx-auto mb-4"></div>
                                        <div className="text-xl font-semibold text-brand-400" style={{ fontSize: '1.25rem' }}>Providing Insights</div>
                                    </div>
                                ) : (
                                    <div className="animate-in">
                                        <div className="w-16 h-16 bg-slate-800/80 rounded-2xl flex items-center justify-center mx-auto mb-5 text-brand-400">
                                            <Icon d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" size="w-7 h-7" />
                                        </div>
                                        <h1 className="text-2xl font-bold text-white mb-1">Upload Tracker</h1>
                                        <p className="text-slate-400 text-sm">Drag & Drop Excel File</p>
                                    </div>
                                )}
                            </div>
                            {loading && (
                                <div style={{ position: 'fixed', bottom: '20px', right: '20px', opacity: 0.7 }}>
                                    <img src="inspired-by-you.png" alt="Inspired By You" style={{ height: '60px', filter: 'brightness(0) saturate(100%) invert(70%) sepia(38%) saturate(1574%) hue-rotate(162deg) brightness(95%) contrast(90%)' }} />
                                </div>
                            )}
                        </div>
                    );
                }

                return (
                    <>
                        <div className="w-full px-8 pt-4 pb-5 space-y-5">
                            <div className="flex flex-col gap-6 animate-in">
                                {/* Header with improved mobile layout */}
                                <div className="flex flex-col md:flex-row items-center justify-between gap-4 mb-4 relative">
                                    <div className="flex items-center gap-4 w-full md:w-auto justify-center md:justify-start">
                                        <img src="logo.png" alt="Logo" className="h-16 md:h-24 object-contain animated-logo" />
                                        <div className="hidden md:block w-px h-12 bg-slate-700/50 mx-2"></div>
                                        <h2 className="text-xl md:text-3xl font-bold text-center md:text-left animated-gradient-text leading-tight">Rejected Bookings<br /><span className="text-slate-500 text-sm md:text-lg font-medium tracking-normal">Dashboard</span></h2>
                                    </div>
                                    <div className="absolute top-0 right-0 md:relative">
                                        <ThemeToggle />
                                    </div>
                                </div>
                            </div>

                            {/* Filters Row */}
                            <div className="flex justify-center items-center gap-4 animate-in">
                                <select value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)}>
                                    <option value="all">All Months</option>
                                    {filters.monthYears.map(m => <option key={m} value={m}>{m}</option>)}
                                </select>
                                <select value={selectedProject} onChange={e => setSelectedProject(e.target.value)}>
                                    <option value="all">All Projects</option>
                                    {filters.projects.map(p => <option key={p} value={p}>{p}</option>)}
                                </select>
                                <button onClick={() => { setRawData(null); setSelectedMonth('all'); setSelectedProject('all'); }} className="px-3 py-1.5 text-sm bg-slate-800/90 rounded-lg text-slate-300 hover:text-white hover:bg-slate-700 border border-slate-600/50 transition-all font-semibold">New File</button>
                            </div>

                            {/* Filter Badges */}
                            {(selectedMonth !== 'all' || selectedProject !== 'all') && (
                                <div className="flex justify-center items-center gap-3 animate-in">
                                    <span className="text-slate-500 text-sm">Filtering:</span>
                                    {selectedMonth !== 'all' && <span className="px-3 py-1 bg-brand-500/20 text-brand-400 rounded-full text-sm font-medium border border-brand-500/30">{selectedMonth}</span>}
                                    {selectedProject !== 'all' && <span className="px-3 py-1 bg-violet-500/20 text-violet-400 rounded-full text-sm font-medium border border-violet-500/30">{selectedProject}</span>}
                                    <button onClick={() => { setSelectedMonth('all'); setSelectedProject('all'); }} className="text-sm text-slate-500 hover:text-white transition-colors">× Clear</button>
                                </div>
                            )}

                            {/* KPI Cards - Icon Left, Content Centered */}
                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 xl:grid-cols-8 gap-3 animate-in delay-1">
                                {/* Rejected Bookings - First */}
                                <div className="glass-card kpi-card rounded-xl p-4 border-l-4 border-indigo-500 flex items-center gap-3">
                                    <svg className="w-6 h-6 text-indigo-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    <div className="flex-1 text-center">
                                        <p className="text-slate-400 text-sm font-bold uppercase tracking-widest">Rejected Bookings</p>
                                        <p className="text-2xl font-bold text-white">{stats.count}</p>
                                    </div>
                                </div>
                                {/* Refunded */}
                                <div className="glass-card kpi-card rounded-xl p-4 border-l-4 border-rose-500 flex items-center gap-3">
                                    <svg className="w-6 h-6 text-rose-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 15v-1a4 4 0 00-4-4H8m0 0l3 3m-3-3l3-3m9 14V5a2 2 0 00-2-2H6a2 2 0 00-2 2v16l4-2 4 2 4-2 4 2z"></path></svg>
                                    <div className="flex-1 text-center">
                                        <p className="text-slate-400 text-sm font-bold uppercase tracking-widest">Refunded</p>
                                        <p className="text-2xl font-bold text-white">{stats.refundedCount}</p>
                                    </div>
                                </div>
                                {/* Swapped */}
                                <div className="glass-card kpi-card rounded-xl p-4 border-l-4 border-teal-500 flex items-center gap-3">
                                    <svg className="w-6 h-6 text-teal-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                                    <div className="flex-1 text-center">
                                        <p className="text-slate-400 text-sm font-bold uppercase tracking-widest">Swapped</p>
                                        <p className="text-2xl font-bold text-white">{stats.swappedCount}</p>
                                    </div>
                                </div>
                                {/* Total Paid */}
                                <div className="glass-card kpi-card rounded-xl p-4 border-l-4 border-blue-500 flex items-center gap-3">
                                    <svg className="w-6 h-6 text-blue-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                    <div className="flex-1 text-center">
                                        <p className="text-slate-400 text-sm font-bold uppercase tracking-widest">Total Paid</p>
                                        <p className="text-lg font-bold text-white">{formatMoney(stats.totalPaid)}</p>
                                    </div>
                                </div>
                                {/* Total Amount Refunded */}
                                <div className="glass-card kpi-card rounded-xl p-4 border-l-4 border-rose-500 flex items-center gap-3">
                                    <svg className="w-6 h-6 text-rose-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
                                    <div className="flex-1 text-center">
                                        <p className="text-slate-400 text-sm font-bold uppercase tracking-widest">Total Amount Refunded</p>
                                        <p className="text-lg font-bold text-rose-400">{formatMoney(stats.totalRefunded)}</p>
                                    </div>
                                </div>
                                {/* Earned */}
                                <div className="glass-card kpi-card rounded-xl p-4 border-l-4 border-emerald-500 flex items-center gap-3">
                                    <svg className="w-6 h-6 text-emerald-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <div className="flex-1 text-center">
                                        <p className="text-slate-400 text-sm font-bold uppercase tracking-widest">Total Revenue Earned from Rejected Bookings</p>
                                        <p className="text-lg font-bold text-emerald-400">{formatMoney(stats.totalEarned)}</p>
                                    </div>
                                </div>
                                {/* Top Agent */}
                                <div className="glass-card kpi-card rounded-xl p-4 border-l-4 border-orange-500 flex items-center gap-3">
                                    <svg className="w-6 h-6 text-orange-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                    <div className="flex-1 text-center min-w-0">
                                        <p className="text-slate-400 text-sm font-bold uppercase tracking-widest truncate">Top Agent</p>
                                        <p className="text-sm font-bold text-white name-wrap" title={stats.topSalesAgent.name}>{stats.topSalesAgent.name}</p>
                                        <p className="text-lg font-bold text-orange-400">{stats.topSalesAgent.value}</p>
                                    </div>
                                </div>
                                {/* Top Broker */}
                                <div className="glass-card kpi-card rounded-xl p-4 border-l-4 border-purple-500 flex items-center gap-3">
                                    <svg className="w-6 h-6 text-purple-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                                    <div className="flex-1 text-center min-w-0">
                                        <p className="text-slate-400 text-sm font-bold uppercase tracking-widest truncate">Top Broker</p>
                                        <p className="text-sm font-bold text-white name-wrap" title={stats.topAgency.name}>{stats.topAgency.name}</p>
                                        <p className="text-lg font-bold text-purple-400">{stats.topAgency.value}</p>
                                    </div>
                                </div>
                            </div>
                            {/* Top 5 Reasons */}
                            <div className="animate-in delay-2">
                                <div className="flex items-center gap-3 mb-5">
                                    <h3 className="text-xl font-bold text-cyan-400 uppercase tracking-wider">Top 5 Rejection Reasons</h3>
                                    <div className="h-px bg-slate-800 flex-1 ml-4 opacity-50"></div>
                                </div>
                                <div className="grid grid-cols-5 gap-4">
                                    {stats.top5Reasons.map((r, i) => (
                                        <div key={i} className={`glass-card kpi-card rounded-2xl p-5 relative overflow-hidden group transition-all duration-300 border ${i === 0 ? 'border-brand-500/50 hover:border-brand-500' :
                                            i === 1 ? 'border-blue-500/50 hover:border-blue-500' :
                                                i === 2 ? 'border-orange-500/50 hover:border-orange-500' :
                                                    i === 3 ? 'border-rose-500/50 hover:border-rose-500' :
                                                        'border-teal-500/50 hover:border-teal-500'
                                            }`}>
                                            {/* Gradient Border Top */}
                                            <div className={`absolute top-0 left-0 w-full h-1 ${i === 0 ? 'bg-gradient-to-r from-brand-400 to-purple-500' :
                                                i === 1 ? 'bg-gradient-to-r from-blue-400 to-cyan-500' :
                                                    i === 2 ? 'bg-gradient-to-r from-orange-400 to-amber-500' :
                                                        i === 3 ? 'bg-gradient-to-r from-rose-400 to-pink-500' :
                                                            'bg-gradient-to-r from-teal-400 to-emerald-500'
                                                }`}></div>

                                            <div className="flex justify-between items-start mb-3">
                                                <span className={`text-xs font-black uppercase tracking-wider py-1 px-2.5 rounded-full ${i === 0 ? 'bg-brand-500/20 text-brand-300' :
                                                    i === 1 ? 'bg-blue-500/20 text-blue-300' :
                                                        i === 2 ? 'bg-orange-500/20 text-orange-300' :
                                                            i === 3 ? 'bg-rose-500/20 text-rose-300' :
                                                                'bg-teal-500/20 text-teal-300'
                                                    }`}>
                                                    #{i + 1}
                                                </span>
                                                <div className="text-right">
                                                    <p className="text-3xl font-black text-white leading-none tracking-tight">{r.value}</p>
                                                </div>
                                            </div>

                                            <p className="text-slate-300 text-sm font-medium leading-snug min-h-[40px] mb-3 line-clamp-3" title={r.name}>{r.name}</p>

                                            {/* Progress Bar */}
                                            <div className="w-full bg-slate-800/50 h-1.5 rounded-full overflow-hidden">
                                                <div className={`h-full rounded-full ${i === 0 ? 'bg-brand-500' :
                                                    i === 1 ? 'bg-blue-500' :
                                                        i === 2 ? 'bg-orange-500' :
                                                            i === 3 ? 'bg-rose-500' :
                                                                'bg-teal-500'
                                                    }`} style={{ width: `${(r.value / stats.top5Reasons[0].value) * 100}%` }}></div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Detail Table */}
                            <div className="glass-card rounded-2xl overflow-hidden animate-in delay-3">
                                <div className="px-6 py-4 bg-gradient-to-r from-slate-900/80 to-slate-800/60 border-b border-slate-700/50 flex justify-between items-center">
                                    <span className="text-white font-bold text-lg">Booking Details</span>
                                    <span className="text-xs text-slate-400 font-medium bg-slate-800 px-3 py-1 rounded-full">{filteredData.length} Records</span>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-900/60 text-xs uppercase tracking-widest font-bold text-slate-300 border-b border-slate-700">
                                            <tr>
                                                <th className="px-5 py-4 whitespace-nowrap text-white w-32 text-center">Rejected Date</th>
                                                <th className="px-5 py-4 whitespace-nowrap text-center">Booking</th>
                                                <th className="px-5 py-4 whitespace-nowrap text-center">Project</th>
                                                <th className="px-5 py-4 whitespace-nowrap text-center">Tower</th>
                                                <th className="px-5 py-4 whitespace-nowrap text-center">Unit</th>
                                                <th className="px-5 py-4 whitespace-nowrap text-center">Customer</th>
                                                <th className="px-5 py-4 whitespace-nowrap text-center">Final Sales Value</th>
                                                <th className="px-5 py-4 whitespace-nowrap text-center">Paid</th>
                                                <th className="px-5 py-4 whitespace-nowrap text-emerald-400 text-center">Earned</th>
                                                <th className="px-5 py-4 text-center" style={{ minWidth: '200px' }}>Reason</th>
                                                <th className="px-4 py-3 text-center text-xs font-bold text-slate-400 uppercase tracking-wider">Reference</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-800/40">
                                            {paginatedData.map((r, i) => (
                                                <tr key={i} className="table-row group hover:bg-slate-800/30 transition-colors">
                                                    <td className="px-5 py-3 text-white font-medium text-base whitespace-nowrap">{r.formattedRejDate}</td>
                                                    <td className="px-5 py-3 text-cyan-300 font-bold text-base whitespace-nowrap">{r.name}</td>
                                                    <td className="px-5 py-3 text-white text-base whitespace-nowrap">{r.project}</td>
                                                    <td className="px-5 py-3 text-sky-200 text-base whitespace-nowrap">{r.building}</td>
                                                    <td className="px-5 py-3 text-sky-200 text-base whitespace-nowrap">{r.unit}</td>
                                                    <td className="px-5 py-3 text-slate-100 text-base whitespace-nowrap">{r.customer}</td>
                                                    <td className="px-5 py-3 text-right text-slate-300 text-base whitespace-nowrap tabular-nums">{r.value.toLocaleString()}</td>
                                                    <td className="px-5 py-3 text-right text-amber-300 text-base font-semibold whitespace-nowrap tabular-nums">{r.paid > 0 ? r.paid.toLocaleString() : '-'}</td>
                                                    <td className="px-5 py-3 text-right text-emerald-400 text-base font-bold whitespace-nowrap tabular-nums">{r.earned > 0 ? r.earned.toLocaleString() : '-'}</td>
                                                    <td className="px-5 py-3"><span className="text-base text-rose-400 font-semibold">{r.reason}</span></td>
                                                    <td className="px-4 py-3 text-center">
                                                        {r.attachment ? (
                                                            <a href={r.attachment} target="_blank" rel="noopener noreferrer" className="inline-flex items-center justify-center w-8 h-8 rounded-full bg-slate-800 hover:bg-cyan-500/20 text-slate-400 hover:text-cyan-400 transition-colors border border-slate-700 hover:border-cyan-500/30" title="Open Reference">
                                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                                            </a>
                                                        ) : (
                                                            <span className="text-slate-600">-</span>
                                                        )}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                {/* Pagination Controls */}
                                {totalPages > 1 && (
                                    <div className="px-6 py-4 border-t border-slate-700/50 flex flex-col sm:flex-row justify-between items-center gap-4 bg-slate-900/40">
                                        <div className="text-sm text-slate-400">
                                            Showing <span className="font-medium text-white">{(currentPage - 1) * itemsPerPage + 1}</span> to <span className="font-medium text-white">{Math.min(currentPage * itemsPerPage, filteredData.length)}</span> of <span className="font-medium text-white">{filteredData.length}</span> results
                                        </div>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                                                disabled={currentPage === 1}
                                                className="px-4 py-2 text-sm bg-slate-800 text-slate-300 rounded-lg hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium"
                                            >
                                                Previous
                                            </button>
                                            <div className="hidden sm:flex gap-1">
                                                {/* Simple page numbers */}
                                                {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                                                    // Logic to show pages around current
                                                    let p = i + 1;
                                                    if (totalPages > 5 && currentPage > 3) p = currentPage - 2 + i;
                                                    if (p > totalPages) p = p - (p - totalPages);
                                                    // Simplified: just show current page context
                                                    return (
                                                        <button
                                                            key={p}
                                                            onClick={() => setCurrentPage(p)}
                                                            className={`w-8 h-8 flex items-center justify-center rounded-lg text-sm font-medium transition-colors ${currentPage === p ? 'bg-brand-500 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                                                        >
                                                            {p}
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                            <button
                                                onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                                                disabled={currentPage === totalPages}
                                                className="px-4 py-2 text-sm bg-slate-800 text-slate-300 rounded-lg hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium"
                                            >
                                                Next
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </>
                );
            };

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);

        } catch (err) {
            document.body.innerHTML = '<div style="color:red; padding:20px;"><h1>Fatal Error</h1><pre>' + err.stack + '</pre></div>';
        }
    </script>
</body>

</html>